<ng-container *ngIf="!loading(); else suspenseTemplate">
  <span id="user">
    Bienvenido(a), {{userRoleObject.nickname}}
    <button mat-mini-fab class="profile-btn" matTooltip="Mi perfil"
      [routerLink]="['/dashboard/usuarios/usuario', {'nombre-de-usuario': userRoleObject.nickname}]">
      <mat-icon>person</mat-icon>
    </button>
  </span>
  <div id="bandsSectionContainer">
    <mat-card class="card" appearance="outlined">
      <mat-card-header>
        <mat-card-title class="path-title">Gestión Bandas</mat-card-title>
      </mat-card-header>
      @if (userRoleObject.role.toString()!=='ROLE_ADMIN') {
      <mat-card-content>
        <p>Realiza una acción respecto a tus bandas guardadas o donde participas.
          Puedes consultar, listar, crear, ver estadísticas de tus bandas y/o
          agregar músicos invitados.</p>
      </mat-card-content>
      <mat-card-footer>
        <div>
          <button routerLink="/dashboard" mat-button>Regresar al menú</button>
          <button routerLink="/" mat-button>Ir al Home</button>
        </div>
      </mat-card-footer>
      } @else {
      <mat-card-content>
        <p>Como administrador puedes obtener el listado de todas las bandas registradas en Bandlogs-Manager</p>
      </mat-card-content>
      <mat-card-footer>
        <div>
          <button routerLink="/dashboard" mat-button>Regresar al menú</button>
          <button routerLink="/" mat-button>Ir al Home</button>
        </div>
      </mat-card-footer>
      }
    </mat-card>
    <app-logged-in-user-menu section="bandas" (menuItemEmitter)="handleMenuItem($event)">
    </app-logged-in-user-menu>
    
    <p id="longText" *ngIf="bandsAreListed() && _bands.length >= 1">{{longText}}</p>
    <button mat-mini-fab id="addBandBtn" matTooltip="Agregar banda" (click)="openFormDialog(getManagingBandEnumType().TO_CREATE, {
            loggedInUsername: userRoleObject.nickname,
            loading,
            cookieService
        }
      )"
    >
      <mat-icon>add</mat-icon>
    </button>
    @if(bandsAreListed() && _bands.length >= 1) {
    <div id="tableContainer">
      <table mat-table [dataSource]="dataSource">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Nombre </th>
          <td mat-cell *matCellDef="let element"> {{element.name}} </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="director">
          <th mat-header-cell *matHeaderCellDef> Director </th>
          <td mat-cell *matCellDef="let element">
            <a [routerLink]="['/dashboard/usuarios/usuario', {'nombre-de-usuario': element.director}]"
              ngClass="user-link">
              {{element.director}}
            </a>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="musicalGenre">
          <th mat-header-cell *matHeaderCellDef> Género musical </th>
          <td mat-cell *matCellDef="let element"> {{translateGenreToESString(element.musicalGenre.toString())}} </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef> 
            <div id="actionColumnHeadBtnContainer">
              <span>Acción</span>
              <button
                mat-icon-button
                class="filter-action-btn"
                [matMenuTriggerFor]="menu"
                matTooltip="Filtro por rol de banda"
              >
                <mat-icon>filter_list</mat-icon> <small>filtrar</small>
              </button>
              <mat-menu #menu="matMenu">
                @if (userRoleObject.role.toString()==='ROLE_ADMIN') {
                <button
                  mat-menu-item
                  (click)="loading.set(true); fetchBands();"
                  [disabled]="allBandsAreListedAsAdmin"
                >
                  Todas las bandas registradas
                </button>
                <button
                  mat-menu-item
                  (click)="filterBandsByUserAsMember(userRoleObject.nickname)"
                  [disabled]="!allBandsAreListedAsAdmin && !bandsAreFilteredByDirector"
                >
                  Bandas donde soy miembro
                </button>
                } @else {
                <button
                  mat-menu-item
                  (click)="loading.set(true); fetchBands();"
                  [disabled]="!bandsAreFilteredByDirector"
                >
                  Bandas donde soy miembro
                </button>
                }
                <button
                  mat-menu-item
                  (click)="filterBandsByUserAsDirector(userRoleObject.nickname)"
                  [disabled]="bandsAreFilteredByDirector"
                >
                  Bandas donde soy director
                </button>
              </mat-menu>
            </div>
          </th>
          <td mat-cell *matCellDef="let element">
            <button [routerLink]="'/dashboard/bandas/'.concat(element.bandId)" mat-stroked-button>
              DETALLES
            </button>
            @if (userRoleObject.role.toString()==='ROLE_ADMIN') {
            <button class="band-delete" (click)="openFormDialog(
                    getManagingBandEnumType().TO_DELETE, {
                      band: element
                    })
                  " mat-icon-button>
              <mat-icon>delete</mat-icon>
            </button>
            } @else {
            @if (element.director===userRoleObject.nickname) {
            <button class="band-update" (click)="openFormDialog(
                      getManagingBandEnumType().TO_UPDATE, {
                        band: element
                      })
                    " mat-icon-button>
              <mat-icon>edit</mat-icon>
            </button>
            <button class="band-delete" (click)="openFormDialog(
                      getManagingBandEnumType().TO_DELETE, {
                        band: element
                      })
                    " mat-icon-button>
              <mat-icon>delete</mat-icon>
            </button>
            
            }
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
    }
    @else {
      @if (bandsAreListed()) {
        <p>No estás asociado a banda alguna, o no eres director.</p>
      }
    }
    @if(userRoleObject.role.toString()!=='ROLE_ADMIN') {
    <mat-card class="card" appearance="outlined">
      <mat-card-header>
        <mat-card-title>Agrega un músico a bandas que diriges donde todavía no es un miembro</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div id="userFormFieldContainer">
          <mat-form-field class="user-form-field">
            <mat-label>nombre de usuario</mat-label>
            <input
              #filterInput
              type="text"
              [matAutocomplete]="auto"
              (focus)="onFilterUsersInputFocus()"
              (input)="filterUsers()"
              [formControl]="userNicknameControl"
              matInput
             />
            <mat-autocomplete requireSelection #auto="matAutocomplete" id="userAutocomplete">
              @for (user of filteredUsers(); track user.userId) {
              <mat-option [value]="user.nickname" class="user-option" [matTooltip]="user.nickname">
                {{user.nickname}}
                <span class="user-fullname">{{user.firstname}} {{user.lastname}}</span>
              </mat-option>
              }
            </mat-autocomplete>
            <mat-error
              *ngIf="
                userNicknameControl.invalid 
                && userNicknameControl.hasError('required') 
                && userNicknameControl.touched
              "
            >
              El campo es obligatorio
            </mat-error>
          </mat-form-field>
          <button type="button" id="search" [disabled]="userNicknameControl.invalid" (click)="openFormDialog(
              getManagingBandEnumType().TO_ADD_MEMBER_TO_BAND)
            " mat-mini-fab>
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </mat-card-content>
      <mat-card-footer class="card-footer">
        <div>
          <button routerLink="/dashboard" mat-button>Regresar al menú</button>
          <button routerLink="/" mat-button>Ir al Home</button>
        </div>
      </mat-card-footer>
    </mat-card>
    }
  </div>
</ng-container>
<!-- Loading bands state template when loading signal value changes  -->
<ng-template #suspenseTemplate>
  <app-form-suspense text="Cargando bandas..." id="suspense"></app-form-suspense>
</ng-template>